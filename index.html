<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hotel Policy Structuring Tool</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-dark: #1a1a2e;
  --bg-dark-secondary: #16213e;
  --bg-surface: #ffffff;
  --bg-page: #f0f2f5;
  --text-primary: #1a1a2e;
  --text-secondary: #5a5a7a;
  --text-light: #ffffff;
  --accent-blue: #4361ee;
  --accent-blue-hover: #3a56d4;
  --critical-red: #dc2626;
  --critical-red-bg: #fef2f2;
  --critical-red-border: #fecaca;
  --standard-green: #16a34a;
  --standard-green-bg: #f0fdf4;
  --standard-green-border: #bbf7d0;
  --others-gray: #6b7280;
  --others-gray-bg: #f9fafb;
  --others-gray-border: #e5e7eb;
  --border-light: #e2e8f0;
  --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
  --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
  --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
  --radius-sm: 6px;
  --radius-md: 8px;
  --radius-lg: 12px;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg-page);
  color: var(--text-primary);
  line-height: 1.6;
  min-height: 100vh;
}

.header {
  background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-dark-secondary) 100%);
  color: var(--text-light);
  padding: 20px 32px;
  box-shadow: var(--shadow-lg);
  position: sticky;
  top: 0;
  z-index: 100;
}
.header h1 { font-size: 20px; font-weight: 700; letter-spacing: -0.3px; }
.header p { font-size: 13px; color: #94a3b8; margin-top: 2px; }

.main { padding: 24px 32px; max-width: 1600px; margin: 0 auto; }

/* Input Section */
.input-section {
  background: var(--bg-surface);
  border-radius: var(--radius-lg);
  padding: 24px;
  box-shadow: var(--shadow-md);
  margin-bottom: 24px;
}
.input-section label {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  display: block;
  margin-bottom: 6px;
}
.policy-textarea {
  width: 100%;
  min-height: 160px;
  padding: 14px;
  border: 1.5px solid var(--border-light);
  border-radius: var(--radius-md);
  font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
  font-size: 13px;
  line-height: 1.7;
  resize: vertical;
  outline: none;
  transition: border-color 0.2s;
  color: var(--text-primary);
}
.policy-textarea:focus { border-color: var(--accent-blue); }
.policy-textarea::placeholder { color: #94a3b8; }

.btn-row { display: flex; gap: 12px; margin-top: 16px; align-items: center; }

.btn-process {
  background: var(--accent-blue);
  color: white;
  border: none;
  padding: 10px 28px;
  border-radius: var(--radius-md);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s;
  display: flex;
  align-items: center;
  gap: 8px;
}
.btn-process:hover { background: var(--accent-blue-hover); }
.btn-process:disabled { opacity: 0.6; cursor: not-allowed; }

.btn-clear {
  background: transparent;
  color: var(--text-secondary);
  border: 1.5px solid var(--border-light);
  padding: 10px 20px;
  border-radius: var(--radius-md);
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-clear:hover { border-color: var(--text-secondary); color: var(--text-primary); }

.btn-copy {
  background: transparent;
  color: var(--text-secondary);
  border: 1.5px solid var(--border-light);
  padding: 10px 20px;
  border-radius: var(--radius-md);
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
  display: none;
}
.btn-copy:hover { border-color: var(--accent-blue); color: var(--accent-blue); }
.btn-copy.visible { display: inline-flex; align-items: center; gap: 6px; }
.btn-copy.copied { border-color: var(--standard-green); color: var(--standard-green); }

.spinner {
  display: none;
  width: 16px; height: 16px;
  border: 2px solid rgba(255,255,255,0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Error */
.error-box {
  background: var(--critical-red-bg);
  border: 1px solid var(--critical-red-border);
  color: var(--critical-red);
  padding: 12px 16px;
  border-radius: var(--radius-md);
  font-size: 13px;
  margin-top: 12px;
  display: none;
}
.error-box.visible { display: block; }

/* Stats Bar */
.stats-bar {
  display: none;
  background: var(--bg-surface);
  border-radius: var(--radius-lg);
  padding: 16px 24px;
  box-shadow: var(--shadow-md);
  margin-bottom: 24px;
}
.stats-bar.visible { display: flex; gap: 32px; align-items: center; flex-wrap: wrap; }
.stat-item { text-align: center; }
.stat-value { font-size: 22px; font-weight: 700; }
.stat-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
.stat-critical .stat-value { color: var(--critical-red); }
.stat-standard .stat-value { color: var(--standard-green); }

/* Output Grid */
.output-section { display: none; }
.output-section.visible { display: block; }

.output-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
}
@media (max-width: 1000px) { .output-grid { grid-template-columns: 1fr; } }

.panel {
  background: var(--bg-surface);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-md);
  overflow: hidden;
}
.panel-header {
  padding: 14px 20px;
  font-size: 13px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.panel-header-blue { background: #eef2ff; color: #4338ca; }
.panel-header-green { background: #f0fdf4; color: #15803d; }
.panel-body { padding: 20px; }

/* Raw Data */
.raw-data-value {
  font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
  font-size: 12px;
  background: #f8fafc;
  padding: 14px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border-light);
  white-space: pre-wrap;
  word-break: break-word;
  max-height: 600px;
  overflow-y: auto;
  line-height: 1.7;
  color: var(--text-primary);
}

/* Policy Cards */
.sensitivity-group { margin-bottom: 20px; }
.sensitivity-group:last-child { margin-bottom: 0; }
.sensitivity-group-header {
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 6px 0;
  margin-bottom: 8px;
}
.sensitivity-group-header.critical { color: var(--critical-red); border-bottom: 2px solid var(--critical-red); }
.sensitivity-group-header.standard { color: var(--standard-green); border-bottom: 2px solid var(--standard-green); }

.policy-card {
  padding: 12px 14px;
  border-radius: var(--radius-md);
  margin-bottom: 8px;
  border-left: 3px solid;
}
.critical-card {
  background: var(--critical-red-bg);
  border-left-color: var(--critical-red);
}
.standard-card {
  background: var(--standard-green-bg);
  border-left-color: var(--standard-green);
}
.policy-card-text { font-size: 13px; font-weight: 500; margin-bottom: 8px; line-height: 1.5; }
.policy-card-meta { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }

.badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 99px;
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}
.badge-critical { background: var(--critical-red); color: white; }
.badge-standard { background: var(--standard-green); color: white; }
.badge-category { background: #e2e8f0; color: var(--text-primary); font-weight: 600; }

.confidence-bar-container { display: flex; align-items: center; gap: 6px; margin-left: auto; }
.confidence-bar {
  width: 60px; height: 6px;
  background: #e2e8f0;
  border-radius: 99px;
  overflow: hidden;
}
.confidence-bar-fill {
  height: 100%;
  border-radius: 99px;
  transition: width 0.3s ease;
}
.confidence-bar-fill.high { background: #22c55e; }
.confidence-bar-fill.medium { background: #f59e0b; }
.confidence-bar-fill.low { background: #ef4444; }
.confidence-label { font-size: 11px; font-weight: 600; color: var(--text-secondary); min-width: 30px; }

/* User Preview */
.preview-critical-box {
  background: #fff7ed;
  border: 1.5px solid #fed7aa;
  border-radius: var(--radius-md);
  padding: 16px;
  margin-bottom: 20px;
}
.preview-critical-header {
  font-size: 14px;
  font-weight: 700;
  color: #c2410c;
  margin-bottom: 12px;
}
.preview-critical-item {
  display: flex;
  align-items: flex-start;
  gap: 8px;
  font-size: 13px;
  padding: 4px 0;
  color: #7c2d12;
  line-height: 1.5;
}
.preview-critical-item .icon { flex-shrink: 0; font-size: 14px; margin-top: 1px; }

.preview-standard-section {
  border: 1px solid var(--border-light);
  border-radius: var(--radius-md);
  margin-bottom: 8px;
  overflow: hidden;
}
.preview-category-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 14px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  background: #f8fafc;
  transition: background 0.2s;
  user-select: none;
}
.preview-category-header:hover { background: #f1f5f9; }
.preview-category-header .chevron {
  font-size: 10px;
  transition: transform 0.2s;
  color: var(--text-secondary);
}
.preview-category-header.expanded .chevron { transform: rotate(180deg); }

.preview-category-body {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
}
.preview-category-body.expanded { max-height: 500px; }

.preview-standard-item {
  padding: 6px 14px 6px 32px;
  font-size: 13px;
  line-height: 1.5;
  position: relative;
  color: var(--text-primary);
}
.preview-standard-item::before {
  content: '‚Ä¢';
  position: absolute;
  left: 18px;
  color: var(--text-secondary);
}
.preview-standard-item:last-child { padding-bottom: 12px; }
.preview-standard-item:first-child { padding-top: 10px; }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 99px; }
::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
</style>
</head>
<body>

<div class="header">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <div>
      <h1>Hotel Policy Structuring Tool</h1>
      <p>Paste raw supplier policy data ‚Üí Get structured, classified output (Powered by Claude)</p>
    </div>
    <div style="display:flex;align-items:center;gap:10px;">
      <label style="font-size:12px;color:#94a3b8;white-space:nowrap;">Anthropic API Key</label>
      <input type="password" id="apiKey" placeholder="sk-ant-..."
        style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;padding:7px 12px;border-radius:6px;font-size:13px;width:260px;outline:none;"
        oninput="saveApiKey(this.value)">
      <div id="apiKeyDot" style="width:8px;height:8px;border-radius:50%;background:#ef4444;flex-shrink:0;"></div>
    </div>
  </div>
  <div style="text-align:right;margin-top:6px;font-size:11px;color:#64748b;letter-spacing:0.3px;">Built with Vibes <span style="color:#f87171;">‚ô•</span></div>
</div>

<div class="main">
  <!-- Input -->
  <div class="input-section">
    <label for="policyText">Paste raw policy text</label>
    <textarea class="policy-textarea" id="policyText" placeholder="Paste the entire policy text here ‚Äî any supplier, any format, any number of policies. Separate multiple policy sections with line breaks.

Example:
Guest Profile
Unmarried couples NOT allowed.
Guests below 18 years of age are not allowed at the property.

Check-in Check-out Policy
Standard check-in time is 14:00 PM and check-out time is 12:00 PM.
Passport, Driving License, Aadhar and Govt. ID are accepted as ID proof(s)."></textarea>
    <div class="btn-row">
      <button class="btn-process" id="btnProcess" onclick="processPolicy()">
        <span id="btnProcessText">Process Policy</span>
        <div class="spinner" id="btnSpinner"></div>
      </button>
      <button class="btn-clear" onclick="clearAll()">Clear</button>
      <button class="btn-copy" id="btnCopy" onclick="copyAsText()">Copy Output</button>
    </div>
    <div class="error-box" id="errorBox"><span id="errorMessage"></span></div>
  </div>

  <!-- Stats -->
  <div class="stats-bar" id="statsBar">
    <div class="stat-item">
      <div class="stat-value" id="statTotal">-</div>
      <div class="stat-label">Total Atoms</div>
    </div>
    <div class="stat-item stat-critical">
      <div class="stat-value" id="statCritical">-</div>
      <div class="stat-label">Critical</div>
    </div>
    <div class="stat-item stat-standard">
      <div class="stat-value" id="statStandard">-</div>
      <div class="stat-label">Standard</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="statConfidence">-</div>
      <div class="stat-label">Avg Confidence</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="statTime">-</div>
      <div class="stat-label">Time</div>
    </div>
  </div>

  <!-- Output -->
  <div class="output-section" id="outputSection">
    <div class="output-grid">
      <!-- Panel A: Raw Input -->
      <div class="panel">
        <div class="panel-header panel-header-blue">Input ‚Äî Raw Policy Text</div>
        <div class="panel-body" id="rawDataPanel"></div>
      </div>
      <!-- Panel B: Structured Output + User Preview -->
      <div class="panel">
        <div class="panel-header panel-header-green">Output ‚Äî Structured Policies</div>
        <div class="panel-body">
          <div id="previewPanel"></div>
          <hr style="border:none;border-top:1px solid var(--border-light);margin:24px 0;">
          <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-secondary);margin-bottom:12px;">Detailed Breakdown</div>
          <div id="extractedPanel"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const SYSTEM_PROMPT = `You are a hotel policy extraction system for an Indian travel booking platform.

You will receive raw hotel policy text from a supplier. Your job is to:
1. Break the text into individual, distinct policy statements (atoms)
2. Classify each atom into a category and sensitivity level
3. Rewrite each atom for clarity while preserving the original detail and meaning

---

IMPORTANT: The supplier's title field (e.g. "Guest Profile", "Other Rules", "Common") is ONLY for traceability. Do NOT use it to determine the category or sensitivity. Classify each policy atom SOLELY based on what the policy text says.

A policy titled "Other Rules" can contain critical couple restrictions.
A policy titled "Food & Beverages" can contain mandatory charges.
A policy titled "Check-in Check-out Policy" can contain ID denial clauses.
Always read the actual text. The title means nothing for classification.

---

TAXONOMY:

CRITICAL ‚Äî policies that cause check-in denial, surprise financial charges, or trip-breaking restrictions:

- couple_restriction: Unmarried or unrelated couples not allowed, or allowed only with conditions (both IDs required, marriage certificate needed, etc.)
- local_id_restriction: Local IDs not accepted for check-in, same-city residents not allowed, right of admission reserved for local residents
- mandatory_charges: Compulsory charges NOT included in the booking price ‚Äî gala dinner supplements, mandatory meal charges, seasonal tariff differences payable at hotel. Must involve a specific charge or explicit "not included in booking" language. Optional fees (breakfast, rollaway bed) are NOT mandatory_charges.
- age_restriction: Minimum age requirement for check-in (e.g. 18+, 21+), bachelors or stag entry not allowed, adults-only property
- nationality_restriction: Only Indian nationals allowed, foreign nationals need specific documents, certain nationalities restricted
- facility_closure: Swimming pool, gym, spa, restaurant, or elevator closed, under renovation, or not operational. Must be a current/active closure, not a general amenity description.

STANDARD ‚Äî informational policies, manageable at check-in, not trip-breaking:

- guest_profile: Couple/unmarried friendly status, male stags allowed or not, adults-only or children allowed, bachelor group policy. Use this for informational guest-type statements that do NOT involve check-in denial. If the text says check-in will be DENIED, use the relevant critical category instead.
- id_documentation: List of accepted ID proof types (Aadhaar, passport, driving license, etc.). Note: if the text also says check-in will be DENIED without ID and no refund given, classify that denial clause as critical under the most relevant critical category, and the ID list itself as standard under id_documentation.
- checkin_checkout: Check-in and check-out timings, early check-in or late check-out fees and availability, front desk hours, key collection process
- child_policy: Children stay free below what age, children chargeable above what age and at what rate, complimentary food for children, infant policy, cribs/cots availability
- extra_bed: Extra bed or mattress availability, charges per night, rollaway bed policy, maximum occupancy rules
- food_beverage: Outside food allowed or not, non-veg food allowed or not, alcohol consumption rules, food delivery (Swiggy/Zomato) allowed or not, in-room dining, complimentary breakfast/meals, restaurant info
- smoking_policy: Smoking rules ‚Äî where allowed, where restricted, designated smoking areas, penalties for smoking in non-smoking rooms
- pet_policy: Pets allowed or not, service animals policy, pet fees, pet deposit, pets on property
- security_deposit: Refundable or non-refundable security deposit amount, payment mode for deposit, refund timeline, damage deposit
- payment_methods: Accepted payment modes ‚Äî cards, UPI, cash, mobile payments
- cancellation_refund: Cancellation deadline (free cancellation before X date/time), cancellation penalties, no-show charges and policy, modification fees, refund terms and timeline
- outside_visitors: Visitor entry policy, visitor hours, charges for day visitors, whether non-guests are allowed in rooms or common areas
- damage_policy: Damage charges, liability for property damage, penalties for broken items, linen damage fees
- long_stay: Policies for stays of 30+ nights, monthly stay rules, extended stay conditions, long-term booking discounts
- party_event_policy: Party/event rules, noise restrictions, quiet hours, music cutoff time, DJ policy, celebration rules
- accessibility: Wheelchair accessibility, elevator availability, disabled-friendly facilities, accessible rooms. Note: if the property is NOT accessible or has no elevator, this is still standard unless it represents a closure/breakdown (which would be facility_closure).
- safety_information: Fire safety, emergency exits, CCTV, security guards, COVID protocols, sanitization measures, health requirements, safe deposit box
- property_rules: Curfew timings, parking, general amenity info, any other property rules not covered by the categories above

OTHERS ‚Äî use this when the policy text does not fit cleanly into any of the above categories, or when you are not confident about the correct classification. Always standard sensitivity.

---

EXTRACTION RULES:

1. One input blob may contain MULTIPLE distinct policy statements separated by |||, newlines, numbered lists, or just run-on sentences. Extract EACH as a separate atom.

2. Display text: Write concise, scannable policy statements. Keep critical specifics (amounts, ages, ID types) but cut filler words and repetitive phrasing. Aim for 1 short sentence per atom, 2 sentences max only when a consequence must be stated. Do not repeat the same information in different words within one atom.
   - BAD (too long): "All guests above 18 years of age must carry a valid photo identity card and address proof at check-in. Failure to provide these documents can result in the hotel denying check-in with no refund."
   - GOOD: "Valid photo ID and address proof mandatory at check-in. Check-in denied with no refund if not provided."
   - BAD (too vague): "Extra charges may apply"
   - GOOD: "Extra bed at INR 500/night, payable at property"
   - BAD (multiple atoms): "Couples not allowed no refund ID required 18+ only"
   - GOOD: Split into separate atoms, one per distinct policy

3. If a policy statement contains BOTH a rule AND a consequence (e.g. "Valid ID is mandatory. Failure to produce ID will result in check-in denial with no refund"), extract them as a SINGLE atom ‚Äî do not split the rule from its consequence. The consequence is what determines the sensitivity.

4. Skip generic boilerplate that adds no specific information to the user:
   - "Special requests are subject to availability"
   - "Additional charges may apply"
   - "Please contact the property for details"
   These are noise. Do not extract them.

5. Skip empty, meaningless, or placeholder text (e.g. ".", "..", blank text). Return an empty array.

6. For policies with specific monetary amounts, ALWAYS preserve the exact amount clearly in the display text. Format prices prominently ‚Äî e.g. "INR 3,500 per person", "INR 500/night", "Rs. 2,000 refundable deposit". Never drop, round, or obscure any price. If a price range is mentioned, preserve both ends. If currency is not specified, assume INR. Prices are the most important detail users look for ‚Äî make them impossible to miss.

7. If you are unsure about the category, use "others" with sensitivity "standard". Do not force a classification you are not confident about.

8. Confidence scoring:
   - 0.90-1.00: Text clearly and unambiguously matches the category. No interpretation needed.
   - 0.75-0.89: Text strongly implies the category but has some ambiguity in wording.
   - 0.60-0.74: Text is vague or could belong to multiple categories. You made a judgment call.
   - Below 0.60: You are guessing. Use "others" category instead.

---

OUTPUT FORMAT:

Return ONLY a JSON object with a "policies" key containing an array. Each item:
{
  "policies": [
    {
      "display_text": "Clean, readable policy statement preserving all specific details",
      "category": "one of the taxonomy slugs above",
      "sensitivity": "critical" or "standard",
      "confidence": 0.0 to 1.0
    }
  ]
}

If the input text is empty or contains no extractable policies, return: {"policies": []}`;

let lastPolicies = [];

const CATEGORY_CONFIG = {
  // Critical
  couple_restriction:      { label: 'Couple Restriction',      emoji: 'üë´', previewLabel: 'üë´ Couple & Bachelor Rules' },
  local_id_restriction:    { label: 'Local ID Restriction',    emoji: 'ü™™', previewLabel: 'ü™™ Local ID Restrictions' },
  mandatory_charges:       { label: 'Mandatory Charges',       emoji: 'üí∞', previewLabel: 'üí∞ Mandatory Charges' },
  age_restriction:         { label: 'Age Restriction',         emoji: 'üéÇ', previewLabel: 'üéÇ Age Requirements' },
  nationality_restriction: { label: 'Nationality Restriction', emoji: 'üåç', previewLabel: 'üåç Nationality Requirements' },
  facility_closure:        { label: 'Facility Closure',        emoji: 'üöß', previewLabel: 'üöß Facility Closures' },
  // Standard
  guest_profile:           { label: 'Guest Profile',           emoji: 'üë§', previewLabel: 'üë§ Guest Profile' },
  id_documentation:        { label: 'ID & Documentation',      emoji: 'ü™™', previewLabel: 'ü™™ ID & Documentation' },
  checkin_checkout:        { label: 'Check-in/out',            emoji: 'üïê', previewLabel: 'üïê Check-in & Check-out' },
  pet_policy:              { label: 'Pet Policy',              emoji: 'üêæ', previewLabel: 'üêæ Pet Policy' },
  food_beverage:           { label: 'Food & Beverage',         emoji: 'üçΩÔ∏è', previewLabel: 'üçΩÔ∏è Food & Beverages' },
  smoking_policy:          { label: 'Smoking Policy',          emoji: 'üö¨', previewLabel: 'üö¨ Smoking Policy' },
  child_policy:            { label: 'Children Policy',         emoji: 'üë∂', previewLabel: 'üë∂ Children Stay Policy' },
  extra_bed:               { label: 'Extra Bed',               emoji: 'üõèÔ∏è', previewLabel: 'üõèÔ∏è Extra Bed Policy' },
  payment_methods:         { label: 'Payment Methods',         emoji: 'üí≥', previewLabel: 'üí≥ Payment Methods' },
  security_deposit:        { label: 'Security Deposit',        emoji: 'üîí', previewLabel: 'üîí Security Deposit' },
  accessibility:           { label: 'Accessibility',           emoji: '‚ôø', previewLabel: '‚ôø Accessibility' },
  safety_information:      { label: 'Safety Info',             emoji: 'üõ°Ô∏è', previewLabel: 'üõ°Ô∏è Safety Information' },
  cancellation_refund:     { label: 'Cancellation/Refund',     emoji: '‚ùå', previewLabel: '‚ùå Cancellation & Refund' },
  outside_visitors:        { label: 'Outside Visitors',        emoji: 'üö™', previewLabel: 'üö™ Outside Visitors' },
  damage_policy:           { label: 'Damage Policy',           emoji: '‚ö†Ô∏è', previewLabel: '‚ö†Ô∏è Damage Policy' },
  long_stay:               { label: 'Long Stay',               emoji: 'üìÖ', previewLabel: 'üìÖ Long Stay (30+ Nights)' },
  party_event_policy:      { label: 'Party & Events',          emoji: 'üéâ', previewLabel: 'üéâ Party & Events' },
  property_rules:          { label: 'Property Rules',          emoji: '‚ÑπÔ∏è', previewLabel: '‚ÑπÔ∏è Property Rules' },
  others:                  { label: 'Others',                  emoji: 'üìã', previewLabel: 'üìã Other Policies' },
};

// API Key persistence
function saveApiKey(val) {
  if (val.trim()) {
    localStorage.setItem('anthropic_api_key', val.trim());
    document.getElementById('apiKeyDot').style.background = '#22c55e';
  } else {
    localStorage.removeItem('anthropic_api_key');
    document.getElementById('apiKeyDot').style.background = '#ef4444';
  }
}
(function loadApiKey() {
  const saved = localStorage.getItem('anthropic_api_key');
  if (saved) {
    document.getElementById('apiKey').value = saved;
    document.getElementById('apiKeyDot').style.background = '#22c55e';
  }
})();

async function processPolicy() {
  const policyText = document.getElementById('policyText').value.trim();
  const apiKey = document.getElementById('apiKey').value.trim();
  hideError();
  if (!apiKey) { showError('Please enter your Anthropic API key in the top-right corner.'); return; }
  if (!policyText) { showError('Please paste some policy text to process.'); return; }

  setLoading(true);
  hideOutput();
  const startTime = performance.now();

  try {
    const maxRetries = 3;
    let responseText = '';
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-haiku-4-20250414',
          max_tokens: 4096,
          temperature: 0.2,
          stream: true,
          system: SYSTEM_PROMPT,
          messages: [{ role: 'user', content: 'Policy text:\n"""' + policyText + '"""' }]
        })
      });

      if (response.status === 529 || response.status === 503 || response.status === 429) {
        if (attempt < maxRetries) {
          const wait = attempt * 3;
          document.getElementById('btnProcessText').textContent = `Retrying in ${wait}s (${attempt}/${maxRetries})...`;
          await new Promise(r => setTimeout(r, wait * 1000));
          continue;
        }
        throw new Error('Claude API is overloaded. Please try again in a minute.');
      }

      if (!response.ok) {
        const errBody = await response.json().catch(() => ({}));
        throw new Error(errBody.error?.message || `API error: ${response.status}`);
      }

      // Stream the response
      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      responseText = '';
      let buffer = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split('\n');
        buffer = lines.pop();
        for (const line of lines) {
          if (!line.startsWith('data: ')) continue;
          const jsonStr = line.slice(6);
          if (jsonStr === '[DONE]') continue;
          try {
            const event = JSON.parse(jsonStr);
            if (event.type === 'content_block_delta' && event.delta?.text) {
              responseText += event.delta.text;
            }
          } catch {}
        }
      }
      break;
    }

    // Strip markdown code fences if present
    let cleaned = responseText.trim();
    if (cleaned.startsWith('```')) {
      cleaned = cleaned.substring(cleaned.indexOf('\n') + 1);
    }
    if (cleaned.endsWith('```')) {
      cleaned = cleaned.slice(0, -3);
    }
    cleaned = cleaned.trim();

    const parsed = JSON.parse(cleaned);
    const policies = parsed.policies || [];
    const elapsed = ((performance.now() - startTime) / 1000).toFixed(1);

    renderOutput(policyText, policies, elapsed);

  } catch (err) {
    showError(err.message);
  } finally {
    setLoading(false);
  }
}

function renderOutput(policyText, policies, elapsed) {
  const criticalOrder = [
    'couple_restriction', 'local_id_restriction', 'mandatory_charges',
    'age_restriction', 'nationality_restriction', 'facility_closure'
  ];

  const criticals = policies.filter(p => p.sensitivity === 'critical').sort((a, b) => {
    const ai = criticalOrder.indexOf(a.category);
    const bi = criticalOrder.indexOf(b.category);
    const aIdx = ai === -1 ? 999 : ai;
    const bIdx = bi === -1 ? 999 : bi;
    if (aIdx !== bIdx) return aIdx - bIdx;
    return (b.confidence || 0) - (a.confidence || 0);
  });

  const standards = policies.filter(p => p.sensitivity !== 'critical').sort((a, b) => {
    return (b.confidence || 0) - (a.confidence || 0);
  });

  const avgConf = policies.length > 0
    ? (policies.reduce((s, p) => s + (p.confidence || 0), 0) / policies.length * 100).toFixed(0) + '%'
    : '-';

  document.getElementById('statTotal').textContent = policies.length;
  document.getElementById('statCritical').textContent = criticals.length;
  document.getElementById('statStandard').textContent = standards.length;
  document.getElementById('statConfidence').textContent = avgConf;
  document.getElementById('statTime').textContent = elapsed + 's';
  document.getElementById('statsBar').classList.add('visible');

  // Panel A: Raw Input
  document.getElementById('rawDataPanel').innerHTML = `<div class="raw-data-value">${esc(policyText)}</div>`;

  // Panel B top: User Preview
  let cHtml = '';
  if (criticals.length > 0) {
    cHtml += '<div class="preview-critical-box">';
    cHtml += '<div class="preview-critical-header">‚ö†Ô∏è Important: Read before booking</div>';
    criticals.forEach(p => {
      const cat = CATEGORY_CONFIG[p.category] || CATEGORY_CONFIG.others;
      cHtml += `<div class="preview-critical-item"><span class="icon">${cat.emoji}</span><span>${esc(p.display_text)}</span></div>`;
    });
    cHtml += '</div>';
  }

  const standardsByCategory = {};
  standards.forEach(p => {
    const cat = p.category || 'others';
    if (!standardsByCategory[cat]) standardsByCategory[cat] = [];
    standardsByCategory[cat].push(p);
  });

  const categoryOrder = [
    'guest_profile', 'checkin_checkout', 'id_documentation', 'child_policy', 'extra_bed',
    'food_beverage', 'smoking_policy', 'pet_policy', 'security_deposit',
    'payment_methods', 'cancellation_refund', 'outside_visitors', 'damage_policy',
    'long_stay', 'party_event_policy', 'accessibility', 'safety_information',
    'property_rules', 'others'
  ];

  const renderCategorySection = (catKey, items) => {
    const catConfig = CATEGORY_CONFIG[catKey] || CATEGORY_CONFIG.others;
    const sectionId = 'preview-section-' + catKey;
    let html = `<div class="preview-standard-section">`;
    html += `<div class="preview-category-header" onclick="togglePreviewSection('${sectionId}', this)">
      <span>${catConfig.previewLabel}</span>
      <span class="chevron">‚ñº</span>
    </div>`;
    html += `<div class="preview-category-body" id="${sectionId}">`;
    items.forEach(p => {
      html += `<div class="preview-standard-item"><span>${esc(p.display_text)}</span></div>`;
    });
    html += '</div></div>';
    return html;
  };

  categoryOrder.forEach(catKey => {
    const items = standardsByCategory[catKey];
    if (items && items.length > 0) cHtml += renderCategorySection(catKey, items);
  });
  Object.keys(standardsByCategory).forEach(catKey => {
    if (categoryOrder.includes(catKey)) return;
    const items = standardsByCategory[catKey];
    if (items && items.length > 0) cHtml += renderCategorySection(catKey, items);
  });

  if (policies.length === 0) {
    cHtml = '<div style="color:var(--text-secondary);font-size:14px;text-align:center;padding:40px 20px;">No policies extracted from this input.</div>';
  }
  document.getElementById('previewPanel').innerHTML = cHtml;

  // Panel B bottom: Detailed cards
  let bHtml = '';
  if (criticals.length > 0) {
    bHtml += '<div class="sensitivity-group">';
    bHtml += '<div class="sensitivity-group-header critical">Critical (' + criticals.length + ')</div>';
    criticals.forEach(p => { bHtml += renderPolicyCard(p, 'critical'); });
    bHtml += '</div>';
  }
  if (standards.length > 0) {
    bHtml += '<div class="sensitivity-group">';
    bHtml += '<div class="sensitivity-group-header standard">Standard (' + standards.length + ')</div>';
    standards.forEach(p => { bHtml += renderPolicyCard(p, 'standard'); });
    bHtml += '</div>';
  }
  if (policies.length === 0) {
    bHtml = '<div style="color:var(--text-secondary);font-size:14px;text-align:center;padding:40px 20px;">No policies extracted.</div>';
  }
  document.getElementById('extractedPanel').innerHTML = bHtml;
  document.getElementById('outputSection').classList.add('visible');

  lastPolicies = policies;
  document.getElementById('btnCopy').classList.add('visible');
}

function renderPolicyCard(p, sensitivity) {
  const conf = Math.round((p.confidence || 0) * 100);
  let confClass = 'high';
  if (conf < 75) confClass = 'low';
  else if (conf < 90) confClass = 'medium';
  const catConfig = CATEGORY_CONFIG[p.category] || CATEGORY_CONFIG.others;
  const badgeSens = sensitivity === 'critical' ? 'badge-critical' : 'badge-standard';
  const cardClass = sensitivity === 'critical' ? 'critical-card' : 'standard-card';
  return `
    <div class="policy-card ${cardClass}">
      <div class="policy-card-text">${esc(p.display_text)}</div>
      <div class="policy-card-meta">
        <span class="badge ${badgeSens}">${sensitivity.toUpperCase()}</span>
        <span class="badge badge-category">${catConfig.emoji} ${catConfig.label}</span>
        <div class="confidence-bar-container">
          <div class="confidence-bar"><div class="confidence-bar-fill ${confClass}" style="width:${conf}%"></div></div>
          <span class="confidence-label">${conf}%</span>
        </div>
      </div>
    </div>`;
}

function togglePreviewSection(sectionId, headerEl) {
  const body = document.getElementById(sectionId);
  if (!body) return;
  const expanded = body.classList.toggle('expanded');
  headerEl.classList.toggle('expanded', expanded);
}

function esc(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function setLoading(loading) {
  const btn = document.getElementById('btnProcess');
  const text = document.getElementById('btnProcessText');
  const spinner = document.getElementById('btnSpinner');
  btn.disabled = loading;
  text.textContent = loading ? 'Processing...' : 'Process Policy';
  spinner.style.display = loading ? 'inline-block' : 'none';
}

function showError(msg) {
  document.getElementById('errorMessage').textContent = msg;
  document.getElementById('errorBox').classList.add('visible');
}
function hideError() { document.getElementById('errorBox').classList.remove('visible'); }
function hideOutput() {
  document.getElementById('outputSection').classList.remove('visible');
  document.getElementById('statsBar').classList.remove('visible');
}
function copyAsText() {
  if (!lastPolicies.length) return;

  const criticalOrder = [
    'couple_restriction', 'local_id_restriction', 'mandatory_charges',
    'age_restriction', 'nationality_restriction', 'facility_closure'
  ];
  const criticals = lastPolicies.filter(p => p.sensitivity === 'critical').sort((a, b) => {
    const aIdx = criticalOrder.indexOf(a.category); const bIdx = criticalOrder.indexOf(b.category);
    return (aIdx === -1 ? 999 : aIdx) - (bIdx === -1 ? 999 : bIdx);
  });
  const standards = lastPolicies.filter(p => p.sensitivity !== 'critical');

  const categoryOrder = [
    'guest_profile', 'checkin_checkout', 'id_documentation', 'child_policy', 'extra_bed',
    'food_beverage', 'smoking_policy', 'pet_policy', 'security_deposit',
    'payment_methods', 'cancellation_refund', 'outside_visitors', 'damage_policy',
    'long_stay', 'party_event_policy', 'accessibility', 'safety_information',
    'property_rules', 'others'
  ];

  let text = '';

  if (criticals.length > 0) {
    text += '‚ö†Ô∏è CRITICAL POLICIES\n';
    text += '‚îÄ'.repeat(40) + '\n';
    criticals.forEach(p => {
      const cat = CATEGORY_CONFIG[p.category] || CATEGORY_CONFIG.others;
      text += `${cat.emoji} [${cat.label}] ${p.display_text}\n`;
    });
    text += '\n';
  }

  const standardsByCategory = {};
  standards.forEach(p => {
    const cat = p.category || 'others';
    if (!standardsByCategory[cat]) standardsByCategory[cat] = [];
    standardsByCategory[cat].push(p);
  });

  const allCats = [...categoryOrder, ...Object.keys(standardsByCategory).filter(k => !categoryOrder.includes(k))];

  if (standards.length > 0) {
    text += 'STANDARD POLICIES\n';
    text += '‚îÄ'.repeat(40) + '\n';
    allCats.forEach(catKey => {
      const items = standardsByCategory[catKey];
      if (!items || items.length === 0) return;
      const catConfig = CATEGORY_CONFIG[catKey] || CATEGORY_CONFIG.others;
      text += `\n${catConfig.previewLabel}\n`;
      items.forEach(p => { text += `  ‚Ä¢ ${p.display_text}\n`; });
    });
  }

  navigator.clipboard.writeText(text.trim()).then(() => {
    const btn = document.getElementById('btnCopy');
    btn.classList.add('copied');
    btn.textContent = 'Copied!';
    setTimeout(() => { btn.classList.remove('copied'); btn.textContent = 'Copy Output'; }, 2000);
  });
}

function clearAll() {
  document.getElementById('policyText').value = '';
  hideError();
  hideOutput();
  lastPolicies = [];
  document.getElementById('btnCopy').classList.remove('visible');
}
</script>
</body>
</html>
